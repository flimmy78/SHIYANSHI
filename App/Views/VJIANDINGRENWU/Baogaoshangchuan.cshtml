
@{
    Layout = "~/Views/Shared/AppCreate.cshtml";
}

<fieldset>

    <div>
        <form id="form1" method="post" enctype="multipart/form-data">



            <div class="input_search">
                <div class="input_search-label">
                    证书编号：
                </div>
                <div class="input_search-field ">
                    <p class="static">
                        <label>@ViewBag.REPORTNUMBER</label>
                    </p>
                    <input type="hidden" name="REPORTNUMBER" value="@ViewBag.REPORTNUMBER" id="REPORTNUMBER"/>
                </div>
            </div>
            <br style="clear:both" />
            <div class="input_search">
                <div class="input_search-label">
                    原始记录：
                </div>
                <div class="input_search-field">
                    <input name="name" type="file" id="file" onChange="sc(this,'Y')"/><br />

                </div>
            </div>
            <div class="input_search">
                <div class="input_search-label">

                </div>
                <div class="input_search-field">
                    <input type="hidden" name="NAME2" value="@ViewBag.NAME2" />
                    <label id="NAMEys">@ViewBag.NAME2</label>
                </div>
            </div>
            <br style="clear:both" />
            <div class="input_search">
                <div class="input_search-label">
                    上传证书：
                </div>
                <div class="input_search-field">
                    <input name="name2" type="file" id="file2" onChange="sc(this,'Z')"/>
                </div>
            </div>

            <div class="input_search">
                <div class="input_search-label">

                </div>
                <div class="input_search-field" style="width:400px">
                    <p class="static">
                        <label id="NAMEzs">@ViewBag.NAME</label>
                    </p>
                    <input type="hidden" name="NAME" value="@ViewBag.NAME" />
                </div>

            </div>
            <br style="clear:both" />
            <div class="input_search-label">
                结论：
            </div>

            <div class="input_search-field">

                <p class="static">

                    <label><input type="radio" checked="checked" name="CONCLUSION" value="合格" id="CONCLUSION1" onclick="jielun(1)" />合格</label>
                    <label><input type="radio" name="CONCLUSION" value="不合格" id="CONCLUSION2" onclick="jielun(2)" />不合格</label>
                </p>
                @if (ViewBag.ShiYanShi == "指示仪表")
                {
                    <select class="form-control  input-inline" id="UNQUALIFIEDTYPE" name="UNQUALIFIEDTYPE" style="width:60%;display:none">
                        <option value="">请选择不合格类型</option>
                        <option value="外观异常">外观异常</option>
                        <option value="通电异常">通电异常</option>
                        <option value="绝缘异常">绝缘异常</option>
                        <option value="指示异常">指示异常</option>
                        <option value="屏显异常">屏显异常</option>
                        <option value="数据超差">数据超差</option>
                        <option value="配件缺失">配件缺失</option>
                        <option value="其他">其他</option>
                    </select>
                }
                else if (ViewBag.ShiYanShi == "数表三相" || ViewBag.ShiYanShi == "数表单相")
                {
                    <select class="form-control  input-inline" id="UNQUALIFIEDTYPE" name="UNQUALIFIEDTYPE" style="width:60%;display:none">
                        <option value="">请选择不合格类型</option>
                        <option value="外观异常">外观异常</option>
                        <option value="数据超差">数据超差</option>
                        <option value="设备故障">设备故障</option>
                        <option value="软件故障">软件故障</option>
                        <option value="配件故障">配件故障</option>
                        <option value="信息缺失">信息缺失</option>
                        <option value="配件缺失">配件缺失</option>
                        <option value="其他">其他</option>
                    </select>
                }
                else if (ViewBag.ShiYanShi == "电能")
                {
                    <select class="form-control  input-inline" id="UNQUALIFIEDTYPE" name="UNQUALIFIEDTYPE" style="width:60%;display:none">
                        <option value="">请选择不合格类型</option>
                        <option value="误差超差">误差超差</option>
                        <option value="开机异常">开机异常</option>
                        <option value="屏显异常">屏显异常</option>
                        <option value="配件缺失">配件缺失</option>
                        <option value="脉冲异常">脉冲异常</option>
                        <option value="外观异常">外观异常</option>
                        <option value="其他">其他</option>
                    </select>
                }
                else if (ViewBag.ShiYanShi == "直流仪器")
                {
                    <select class="form-control  input-inline" id="UNQUALIFIEDTYPE" name="UNQUALIFIEDTYPE" style="width:60%;display:none">
                        <option value="">请选择不合格类型</option>
                        <option value="外观异常">外观异常</option>
                        <option value="开机异常">开机异常</option>
                        <option value="屏显异常">屏显异常</option>
                        <option value="配件缺失">配件缺失</option>
                        <option value="数据超差">数据超差</option>
                        <option value="设备故障">设备故障</option>
                        <option value="其他">其他</option>
                    </select>
                }
                else if (ViewBag.ShiYanShi == "互感器")
                {
                    <select class="form-control  input-inline" id="UNQUALIFIEDTYPE" name="UNQUALIFIEDTYPE" style="width:60%;display:none">
                        <option value="">请选择不合格类型</option>
                        <option value="外观异常">外观异常</option>
                        <option value="开机异常">开机异常</option>
                        <option value="屏显异常">屏显异常</option>
                        <option value="配件缺失">配件缺失</option>
                        <option value="数据超差">数据超差</option>
                        <option value="其他">其他</option>
                    </select>
                }
                else
                {
                    <select class="form-control  input-inline" id="UNQUALIFIEDTYPE" name="UNQUALIFIEDTYPE" style="width:60%;display:none">
                        <option value="">请选择不合格类型</option>
                        <option value="外观异常">外观异常</option>
                        <option value="数据超差">数据超差</option>
                        <option value="设备故障">设备故障</option>
                        <option value="软件故障">软件故障</option>
                        <option value="配件故障">配件故障</option>
                        <option value="信息缺失">信息缺失</option>
                        <option value="配件缺失">配件缺失</option>
                        <option value="其他">其他</option>
                    </select>
                }


                <input type="text" id="CONCLUSION_EXPLAIN" name="CONCLUSION_EXPLAIN" value="@ViewBag.CONCLUSION_EXPLAIN" />
            </div>

            <div class="input_search">
                <div class="input_search-label">
                    <span style='color:#F00'>*</span>核验员：
                </div>
                <div class="input_search-field">
                    @Html.DropDownList("DETECTERID", Models.SysPersonModels.GetMyName(), "请选择", new { id = "DETECTERID", @class = "easyui-combobox" })
                </div>
            </div><br style="clear:both;" />

            <div class="input_search">
                @*检定日期*@
                @if (ViewBag.CERTIFICATE_CATEGORY == "检定")
                {
                    <div class="input_search-label">
                        <span style='color:#F00'>*</span>检定日期：
                    </div>
                }
                else if (ViewBag.CERTIFICATE_CATEGORY == "校准")
                {
                    <div class="input_search-label">
                        <span style='color:#F00'>*</span>校准日期：
                    </div>
                }
                <div class="input_search-field">
                    <input type="text" id="CALIBRATION_DATE" name="CALIBRATION_DATE" value="@ViewBag.CALIBRATION_DATE" />
                </div>
            </div>
            <div class="input_search">
                @if (ViewBag.CERTIFICATE_CATEGORY == "检定")
                {
                    <div class="input_search-label">
                        <span style='color:#F00'>*</span>有效期：
                    </div>
                }
                else if (ViewBag.CERTIFICATE_CATEGORY == "校准")
                {
                    <div class="input_search-label">
                        有效期：
                    </div>
                }
                <div class="input_search-field">
                    <input type="text" id="VALIDITY_PERIOD" name="VALIDITY_PERIOD" value="@ViewBag.VALIDITY_PERIOD" />年
                </div>
            </div>

            <input type="hidden" name="PREPARE_SCHEMEID" value="@ViewBag.PREPARE_SCHEMEID" id="PREPARE_SCHEMEID"/>
            <input type="hidden" name="ID" value="@ViewBag.FILE_UPLOADERID" id="FILE_UPLOADERID" />




            <div class="clear"></div>
            <div class="input_search">
                <div class="input_search-label">

                </div>
                <div class="input_search-field">               

                    <input id="fashongid" type="button" class="my-btn" value="发送审核" onclick="songwangshenghe()" />

                    <input type="button" onclick="javascript: window.location.href = '/VJIANDINGRENWU/Index';" value="返回" class="my-btn" />

                </div>
            </div>

        </form>
    </div>

</fieldset>

<script type="text/javascript">
    $(function () {
        //添加日期控件
        $("#CALIBRATION_DATE").datebox({ "required": true });//true为必填项
        //加载核验员
        if ("@ViewBag.DETECTERID" != "") {
            $("#DETECTERID").val('@ViewBag.DETECTERID');
        }
        //输入框的禁用
        if ("@ViewBag.REPORTSTATUS" == "@Common.REPORTSTATUS.审核驳回.ToString()" || "@ViewBag.REPORTSTATUS" == "@Common.REPORTSTATUS.批准驳回.ToString()" || "@ViewBag.REPORTSTATUS" == "") {
            //return true;
        }
        else {
            $("#Submit1,#fashongid").attr("disabled", true)
        }
        if ("@ViewBag.CONCLUSION" != "") {
            @*$("input[type=radio]").attr("checked", "@ViewBag.CONCLUSION");*@
            if ("@ViewBag.CONCLUSION" == "合格") {
                $("#CONCLUSION1").attr("checked", "checked");
                $("#CONCLUSION_EXPLAIN").hide();
            }
            else if ("@ViewBag.CONCLUSION" == "不合格") {
                $("#CONCLUSION2").attr("checked", "checked");
                $("#UNQUALIFIEDTYPE").show();
                $("#CONCLUSION_EXPLAIN").show();
            }
        } else {
            $("#CONCLUSION_EXPLAIN").hide();
        }
        if ("@ViewBag.Create" == "True") {
            $.messager.alert('操作提示', "上传成功！", 'info');
        }
        else if ("@ViewBag.Create" == "False") {
            $.messager.alert('操作提示', "上传失败！", 'error');
            $("#hiddenID").val(null);
        }
        if ("@ViewBag.Edit" == "True") {
            $.messager.alert('操作提示', "上传修改成功！", 'info');
        }
        else if ("@ViewBag.Edit" == "False") {
            $.messager.alert('操作提示', "上传修改失败！", 'error');
        }
    })
    //发送审核
    function songwangshenghe() {


        if ($('input[name=CONCLUSION]:checked').val() == '不合格') {

            var con = $('#UNQUALIFIEDTYPE').find("option:selected").val();
            if (con == '' || con == null) {
                $.messager.alert('操作提示', '请选择不合格类型！', 'info');
                return false;
            }
        }

        var DETECTERID = $("#DETECTERID").combobox('getValue');
        var CALIBRATION_DATE = $('#CALIBRATION_DATE').datebox('getValue');//检定/校准日期
        var VALIDITY_PERIOD = $("#VALIDITY_PERIOD").val();//
        var arr = {
            ID: "@ViewBag.PREPARE_SCHEMEID"+"|"+$("#FILE_UPLOADERID").val(),
            REPORTSTATUS: "@Common.REPORTSTATUS.待审核",
            REPORTSTATUSZI: "@Common.REPORTSTATUS.待审核.GetHashCode()",
            AUDITDATE: "@DateTime.Now;",
            DETECTERID: DETECTERID,
            CALIBRATION_DATE: CALIBRATION_DATE,
            CHECKERID: "@ViewBag.CHECKERID",
            VALIDITY_PERIOD: VALIDITY_PERIOD,
            CONCLUSION: $('input[name=CONCLUSION]:checked').val(),
            UNQUALIFIEDTYPE: $('#UNQUALIFIEDTYPE').find("option:selected").val(),
            CONCLUSION_EXPLAIN: $("#CONCLUSION_EXPLAIN").val(),
            REPORTNUMBER: $("#REPORTNUMBER").val()
        }

        if (arr.DETECTERID != "" && arr.CALIBRATION_DATE != "") {

            if (isNumber(arr.VALIDITY_PERIOD)) {

                var zhi = (CALIBRATION_DATE + "").split('-');
                var nian = parseInt(zhi[0]) + parseInt(arr.VALIDITY_PERIOD);
                var ri = parseInt(zhi[2]) - 1;
                arr.VALIDITYEND = nian + "-" + zhi[1] + "-" + ri;
            }
            else if (null == (arr.VALIDITY_PERIOD) || '' == (arr.VALIDITY_PERIOD)) {


            }
            else {

                $.messager.alert('操作提示', '请输入年限！', 'info');
                return;
            }

            if ($("#NAMEzs").html() != "" && $("#NAMEys").html() != "") {
                $.ajax({
                    url: "/VJIANDINGRENWU/ShengHe",
                    type: "POST",
                    data: arr,
                    // async: false,
                    success: function (res) {
                        if (res.FX) {
                            $("#Submit1,#fashongid").attr("disabled", true);
                            $.messager.alert('操作提示', "发送审核成功！", 'info');
                        }
                        else {
                            $.messager.alert('操作提示', "发送审核失败！", 'error');
                        }
                    }
                })
                return true;
            }
            else {
                $.messager.alert('操作提示', "请先上传文件！", 'info');
                return false;
            }

        }
        else {
            $.messager.alert('操作提示', "请选择核验员和检定/校准时间！", 'info');
            return false;
        }
    }
    //正整数判断
    function isNumber(s) {
        var regu = /^[0-9]*[1-9][0-9]*$/;
        if (regu.test(s)) {
            return true;
        } else {

            return false;
        }
    }
    //时间校验
    function jaoyanshijian(e) {
        var zhi = e;
        if (zhi != "") {
            var regu = "(([0-9]{3}[1-9]|[0-9]{2}[1-9][0-9]{1}|[0-9]{1}[1-9][0-9]{2}|[1-9][0-9]{3})-(((0[13578]|1[02])-(0[1-9]|[12][0-9]|3[01]))|((0[469]|11)-(0[1-9]|[12][0-9]|30))|(02-(0[1-9]|[1][0-9]|2[0-8]))))|((([0-9]{2})(0[48]|[2468][048]|[13579][26])|((0[48]|[2468][048]|[3579][26])00))-02-29)";
            var re = new RegExp(regu);
            if (!re.test(zhi)) {
                $.messager.alert('操作提示', "时间格式不对!", 'info');
                return false;
            }
        }

    }
    function jielun(e) {
        if (e == 1) {
            $("#UNQUALIFIEDTYPE").hide();
            $("#UNQUALIFIEDTYPE").val("");
            $("#CONCLUSION_EXPLAIN").hide();

        }
        else if (e == 2) {
            $("#UNQUALIFIEDTYPE").show();
            $("#CONCLUSION_EXPLAIN").show();

        }
    }

    //上传
    function sc(fi,zhi) {        
        var file = fi.files[0];
        var formData = new FormData();
        //formData.append('file', $('#file')[0].files[0]);
        formData.append('file', file);//文件
        formData.append('chuanzhi', zhi);//类型
        formData.append('PREPARE_SCHEMEID', $('#PREPARE_SCHEMEID').val());//预备方案表ID
        formData.append('FILE_UPLOADERID', $('#FILE_UPLOADERID').val());//附件表ID
        $.ajax({
            url: '/VJIANDINGRENWU/ShangChuang',
            type: 'POST',
            cache: false,
            data: formData,
            processData: false,
            contentType: false
        }).done(function (res) {
            if (res.FH) {
                if (zhi=="Z") {
                    $("#NAMEzs").html(res.Name);
                }
                else if (zhi == "Y") {
                    $("#NAMEys").html(res.Name);
                }
                $("#FILE_UPLOADERID").val(res.FILE_UPLOADERID);
            } else {
                $.messager.alert('操作提示', "出错！", 'info');
                return false;
            }
            var file = $(fi);
            file.after(file.clone().val(""));
            file.remove();          
        }).fail(function (res) {
            $.messager.alert('操作提示', "出错！", 'info');
            return false;
        });
    }
</script>
